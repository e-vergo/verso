# Verso (Side-by-Side Blueprint Fork)

Fork of [leanprover/verso](https://github.com/leanprover/verso) for the [Side-by-Side Blueprint](https://github.com/e-vergo/Side-By-Side-Blueprint) toolchain.

**Upstream:** https://github.com/leanprover/verso

## Fork Purpose

This fork extends Verso with document genres for formalization documentation:
- **SBSBlueprint**: Side-by-side LaTeX/Lean blueprints with dependency graphs
- **VersoPaper**: Academic papers linking to formalizations
- **Rainbow bracket highlighting**: Depth-based bracket coloring for Lean code

## Modifications from Upstream

### 1. SBSBlueprint Genre (`src/verso-sbs/`)

Document genre for formalization blueprints with side-by-side LaTeX/Lean display.

**Block Directives:**

| Directive | Purpose |
|-----------|---------|
| `:::leanNode "label"` | Full side-by-side display (statement + proof + Lean code) |
| `:::paperStatement "label"` | Statement with Lean signature only |
| `:::paperFull "label"` | Statement + proof + full Lean code |
| `:::paperProof "label"` | Proof body only |
| `:::leanModule "Module.Name"` | All blueprint nodes from a module |

**Inline Roles:**

| Role | Purpose |
|------|---------|
| `{nodeRef "label"}` | Cross-reference link to a blueprint node |
| `{statusDot "proven"}` | Colored status indicator dot |
| `{htmlSpan "class"}` | Span wrapper with custom CSS classes |

### 2. VersoPaper Genre (`src/verso-paper/`)

Document genre for academic papers with links to formalizations (without displaying Lean code directly).

**Block Directives:**

| Directive | Purpose |
|-----------|---------|
| `:::paperStatement "label"` | LaTeX statement with link to Lean code |
| `:::paperFull "label"` | Full side-by-side display |
| `:::paperProof "label"` | Proof body only |
| `:::leanNode "label"` | Insert a blueprint node by label |
| `:::leanModule "ModuleName"` | Insert all nodes from a module |
| `:::htmlDiv "classes"` | Wrapper div with custom CSS classes |
| `:::htmlWrapper "tag"` | Wrapper with custom HTML tag |

**Inline Roles:**

| Role | Purpose |
|------|---------|
| `{ref "label"}` | Cross-reference link to a blueprint node |
| `{lean "code"}` | Inline Lean code with syntax highlighting |
| `{span "classes"}` | Span wrapper with custom CSS classes |

### 3. Rainbow Bracket Highlighting (`src/verso/Verso/Code/Highlighted.lean`)

Added bracket matching with depth-based coloring via the `Brackets` namespace:

| Function | Purpose |
|----------|---------|
| `toHtmlRainbow` | Main entry point for rendering with rainbow brackets |
| `renderTextWithBrackets` | Core rainbow bracket rendering |
| `collectFromHighlighted` | Bracket position extraction from highlighted code |
| `matchBrackets` | Bracket pair matching with depth tracking |

**Implementation:**

- Two-pass algorithm: collect brackets, then render with coloring
- 6-color cycling across `()`, `[]`, `{}` with shared global depth counter
- Unmatched brackets marked with `.lean-bracket-error` class
- Brackets inside string literals and doc comments are not colored
- Line comments (`-- ...`) wrapped in `.line-comment` spans
- CSS classes: `.lean-bracket-1` through `.lean-bracket-6`

**CSS (embedded in `highlightingStyle`):**

Light mode colors:
```css
.lean-bracket-1 { color: #d000ff; }  /* Purple */
.lean-bracket-2 { color: #5126ff; }  /* Indigo */
.lean-bracket-3 { color: #0184BC; }  /* Cyan */
.lean-bracket-4 { color: #4078F2; }  /* Blue */
.lean-bracket-5 { color: #50A14F; }  /* Green */
.lean-bracket-6 { color: #E45649; }  /* Red */
```

Dark mode uses brighter variants via `@media (prefers-color-scheme: dark)`.

## Position in Toolchain

```
SubVerso -> LeanArchitect -> Dress -> Runway
              |
              +-> Verso (this fork)
```

Both genres load `manifest.json` (generated by Dress) and pre-rendered artifacts from `.lake/build/dressed/`.

## Usage

```toml
# lakefile.toml
[[require]]
name = "verso"
git = "https://github.com/e-vergo/verso.git"
rev = "main"
```

```lean
import SBSBlueprint

#doc (SBSBlueprint) "My Blueprint" =>

# Chapter One

:::leanNode "thm:main"

This inserts the full side-by-side display for the node labeled "thm:main".
```

## Dependencies

- **Lean:** v4.27.0
- **SubVerso:** https://github.com/e-vergo/subverso.git (SBS fork with O(1) indexed lookups)

## Key Files

| File | Purpose |
|------|---------|
| `src/verso-sbs/SBSBlueprint/Genre.lean` | Genre type definition and BlockExt/InlineExt |
| `src/verso-sbs/SBSBlueprint/Hooks.lean` | Directive expanders (leanNode, paperStatement, etc.) |
| `src/verso-sbs/SBSBlueprint/Render.lean` | HTML rendering for blueprint blocks |
| `src/verso-sbs/SBSBlueprint/Manifest.lean` | Manifest.json loading and node lookup |
| `src/verso-paper/VersoPaper/Blocks.lean` | Paper directive expanders |
| `src/verso-paper/VersoPaper/Html.lean` | HTML rendering for paper blocks |
| `src/verso/Verso/Code/Highlighted.lean` | Rainbow bracket implementation |

## Tooling

For build commands, screenshot capture, compliance validation, and archive management, see the [Archive & Tooling Hub](../../dev/storage/README.md).

### Local Development

To build a project using this fork:

```bash
# From a project directory with lakefile.toml and runway.json
cd /path/to/project
python ../../dev/scripts/build.py
```

The build script handles:
1. Syncing all repos to GitHub
2. Building SubVerso, LeanArchitect, Dress, and Runway in order
3. Building the project with `BLUEPRINT_DRESS=1`
4. Generating dependency graph and manifests
5. Building the site
6. Starting a local server at localhost:8000

Options: `--dry-run`, `--skip-cache`, `--verbose`, `--capture`

## License

Apache 2.0. Core Verso framework copyright Lean FRO LLC. Fork modifications for Side-by-Side Blueprint.

For upstream Verso documentation, see [leanprover/verso](https://github.com/leanprover/verso).
