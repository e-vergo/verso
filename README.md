# Verso (Side-by-Side Blueprint Fork)

This is a fork of [Verso](https://github.com/leanprover/verso), the official authoring tool for Lean documentation developed by David Thrane Christiansen. This fork adds genres for mathematical blueprint documents that display formal Lean proofs alongside LaTeX theorem statements.

## Attribution

The core Verso framework is developed by the Lean team at the Lean FRO. This fork adds the `SBSBlueprint` and `VersoPaper` genres for the [Side-by-Side Blueprint](https://github.com/e-vergo/Side-By-Side-Blueprint) toolchain. All original Verso functionality remains intact.

**Upstream repository**: https://github.com/leanprover/verso

## What is Verso?

Verso is a document authoring system for Lean that provides:

- A Markdown-like concrete syntax for writing documents
- Full access to Lean's metaprogramming API for custom extensions
- Accurate syntax highlighting via integration with Lean's parser
- Genre-based architecture for different document types (manuals, blogs, tutorials)
- Cross-document hyperlinking via semantic reference databases

Documents in Verso are Lean programs that produce structured output, enabling compile-time verification of code examples and integration with the Lean environment.

## Fork Additions

This fork adds two new genres to Verso:

### SBSBlueprint Genre

A genre for mathematical formalization blueprints that pairs LaTeX theorem statements with their Lean formalizations in a side-by-side display.

**Key features**:

- Side-by-side rendering of LaTeX and Lean code
- 6-status color model (notReady, ready, sorry, proven, fullyProven, mathlibReady)
- Dependency tracking via `\uses{}` relationships
- Dashboard generation with project statistics
- Integration with pre-rendered artifacts from [Dress](https://github.com/e-vergo/Dress)

**Block directives**:

| Directive | Purpose |
|-----------|---------|
| `:::leanNode "label"` | Full side-by-side display (statement + proof + Lean code) |
| `:::paperStatement "label"` | Statement with Lean signature only |
| `:::paperFull "label"` | Statement + proof + full Lean code |
| `:::paperProof "label"` | Proof body only |
| `:::leanModule "Module.Name"` | All nodes from a module |

**Inline roles**:

| Role | Purpose |
|------|---------|
| `{nodeRef "label"}` | Reference link to a blueprint node |
| `{statusDot "proven"}` | Status indicator dot |
| `{htmlSpan "class"}` | HTML span wrapper |

### VersoPaper Genre

A genre for academic papers with blueprint integration. Allows writing papers in pure Verso markup with hooks to pull pre-built artifacts.

**Features**:

- Same directive set as SBSBlueprint
- Paper-specific styling with verification badges
- Links back to the full blueprint
- PDF generation support (via external LaTeX compilation)

## Architecture

### Genre Definition

Both genres follow Verso's genre architecture:

```lean
def SBSBlueprint : Genre where
  PartMetadata := BlueprintMetadata
  Block := BlockExt
  Inline := InlineExt
  TraverseContext := TraverseContext
  TraverseState := TraverseState
```

The `BlueprintMetadata` type captures per-section metadata:

```lean
structure BlueprintMetadata where
  id : Option String := none
  title : Option String := none
  keyDeclaration : Bool := false
  message : Option String := none
  priorityItem : Bool := false
  blocked : Option String := none
  potentialIssue : Option String := none
  technicalDebt : Option String := none
  misc : Option String := none
  manualStatus : Option NodeStatus := none
  number : Bool := true
  htmlId : Option String := none
```

### Node Status

Blueprint nodes have a 6-status color model:

| Status | Color | Source |
|--------|-------|--------|
| `notReady` | Sandy Brown (#F4A460) | Default or manual flag |
| `ready` | Light Sea Green (#20B2AA) | Manual flag |
| `sorry` | Dark Red (#8B0000) | Auto-detected from proof |
| `proven` | Light Green (#90EE90) | Auto-detected (complete proof) |
| `fullyProven` | Forest Green (#228B22) | Auto-computed (all ancestors proven) |
| `mathlibReady` | Light Blue (#87CEEB) | Manual flag |

### Manifest Integration

The genres load `manifest.json` (generated by Dress) at render time:

```lean
structure BlueprintManifest where
  nodes : HashMap String String := {}  -- label -> URL
  stats : StatusCounts := {}
  checks : CheckResults := {}
  keyDeclarations : Array String := #[]
  messages : Array MessageItem := #[]
  projectNotes : ProjectNotes := {}
```

The manifest is cached via an environment extension to avoid repeated file reads during elaboration.

### Artifact Loading

Pre-rendered artifacts are loaded from `.lake/build/dressed/{Module}/{label}/`:

| File | Content |
|------|---------|
| `decl.html` | Syntax-highlighted Lean code |
| `decl.tex` | LaTeX source |
| `decl.json` | Metadata (declaration names, etc.) |
| `decl.hovers.json` | Hover tooltip data |

## Usage

### As a Dependency

Add to your `lakefile.lean`:

```lean
require verso from git "https://github.com/e-vergo/verso.git"@"main"
```

Or `lakefile.toml`:

```toml
[[require]]
name = "verso"
git = "https://github.com/e-vergo/verso.git"
rev = "main"
```

### Writing a Blueprint Document

```lean
import SBSBlueprint

open Verso.Genre.SBSBlueprint

-- Document structure using Verso syntax
#doc (SBSBlueprint) "My Blueprint" =>

# Chapter One

:::leanNode "thm:main"

This displays the main theorem with its Lean formalization.

:::leanModule "MyProject.Lemmas"

This inserts all nodes from the specified module.
```

### Rendering

The genres provide `GenreHtml` instances for HTML generation. Rendering requires a `RenderContext`:

```lean
structure RenderContext where
  manifest : Option BlueprintManifest := none
  baseUrl : String := "/"
  artifactDir : System.FilePath := ".lake/build/dressed"
  paperMode : Bool := false
  blueprintBaseUrl : Option String := none
```

## Package Structure

| Library | Location | Purpose |
|---------|----------|---------|
| `SBSBlueprint` | `src/verso-sbs/` | Blueprint genre |
| `VersoPaper` | `src/verso-paper/` | Paper genre |
| `Verso` | `src/verso/` | Core framework (upstream) |
| `VersoManual` | `src/verso-manual/` | Manual genre (upstream) |
| `VersoBlog` | `src/verso-blog/` | Blog genre (upstream) |

### SBSBlueprint Module Structure

| Module | Purpose |
|--------|---------|
| `SBSBlueprint.Genre` | Genre definition, types, traversal instances |
| `SBSBlueprint.Hooks` | Directive and role expanders |
| `SBSBlueprint.Manifest` | Manifest types and loading |
| `SBSBlueprint.Render` | HTML rendering functions |
| `SBSBlueprint.Main` | Additional utilities |

## Dependencies

This fork uses a modified SubVerso for syntax highlighting:

```lean
require subverso from git "https://github.com/e-vergo/subverso.git"@"main"
```

The SubVerso fork includes O(1) indexed lookups for performance and graceful error handling.

## Integration with Side-by-Side Blueprint

This Verso fork is part of the larger Side-by-Side Blueprint toolchain:

1. **LeanArchitect**: Defines `@[blueprint]` attribute for marking declarations
2. **Dress**: Generates artifacts during Lean compilation
3. **Verso (this fork)**: Provides document genres for rendering
4. **Runway**: Site generator that consumes Verso output

The typical build flow:

```
Lean source + @[blueprint] annotations
    |
    v
Dress captures during elaboration
    |
    v
Artifacts in .lake/build/dressed/
    |
    v
Verso genres render using artifacts
    |
    v
Runway generates final site
```

## Testing

Run tests with:

```bash
lake test
```

Browser tests for JavaScript functionality are in `browser-tests/` and require Playwright.

## License

Verso is licensed under the Apache 2.0 license. See [LICENSE](./LICENSE) for details.

Third-party JavaScript components in `vendored-js/` are provided under the MIT license with their own copyright notices.
